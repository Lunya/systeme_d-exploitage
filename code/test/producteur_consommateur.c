#include "syscall.h"
#define MAX 50
/*
 * Ce programme, qui permet de tester l'appel système GetChar,
 * consiste tout simplement à effectuer une boucle infini où
 * l'utilisateur à juste à rentrer des caractères, et chaque 
 * caractère est récupéré à l'aide de l'appel système GetChar.
 * Pour le test, chaque caractère est ensuite raffiché à l'aide
 * de l'appel système PutChar, pour pouvoir faire une comparaison
 * facile. 
*/

sem_t cons;
sem_t prod;
sem_t mutexC;
sem_t mutexP;

char pipe[MAX];
int index=0;
void produire(char c)
{
	P(mutexP);
	P(prod);
	//put(c);
	pipe[index] = c;
	index++;
	V(cons);
	V(mutexP);
}

void consommer()
{
	int i;
	P(mutexC);
	P(cons);
	//get(c);
	//PutChar(c);
	PutChar(pipe[0]);
	for (i=0;i<index;i++)
	{
		pipe[i] = pipe[i+1];
	}
	index--;
	V(prod);
	V(mutexC);
}
void user_ThreadCreate(void f(void *arg), void *arg) {
	ThreadCreate(f, arg, ThreadExit);
}
int main()
{
	cons = SemaphoreCreate(0);
	prod = SemaphoreCreate(MAX);
	mutexC = SemaphoreCreate(1);
	mutexP = SemaphoreCreate(1);
	//char c;
	user_ThreadCreate(consommer, ' ');
	user_ThreadCreate(produire, 's');
	user_ThreadCreate(produire, 'a');
	user_ThreadCreate(consommer, ' ');
	user_ThreadCreate(consommer, ' ');
	user_ThreadCreate(produire, 'l');
	user_ThreadCreate(consommer, ' ');
	user_ThreadCreate(produire, 'u');
	user_ThreadCreate(produire, 't');
	user_ThreadCreate(consommer, ' ');

// Nous ne savons pas quand "savoir" quand il faut détruire les sémaphores.
// Il faudrait utiliser des semaphores pour cela, et du coup, comment savoir
// Ce n'est donc pas très optimisé pour l'instant, mais les appels sytèmes
// permettant de le faire sont quand même implémentés
/*
	SemaphoreExit(cons);
	SemaphoreExit(prod);
	SemaphoreExit(mutexC);
	SemaphoreExit(mutexP);
	*/
}